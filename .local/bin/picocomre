#!/bin/bash

# save opts
opts=$@

# find the device argument
while [[ $1 && $1 != "/dev/"* ]]; do
  shift;
done;

while [[ 1 ]]; do
  # wait for the device node
  echo
  printf "x%.0s" {1..24}
  echo
  printf "Waiting for %s\n" $1
  printf "x%.0s" {1..24}
  echo; echo
  while [[ ! -e "$1" ]]; do
    sleep 1
  done;

  # quit if busy
  if [[ $(lsof $1) ]]; then
    echo "$1 busy!"; echo
    lsof $1
    exit 1
  fi

  # connect
  picocom $opts
  if [[ $? -eq 0 ]]; then
    exit 0
  fi
done
